# Maintainer: Jeroen Ooms <jeroen@berkeley.edu>

_realname=r-debug
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=3.7.0
pkgrel=1
pkgdesc="Debugging build for base R (mingw-w64)"
arch=('any')
url="https://www.r-project.org"
license=(GPL2)
makedepends=("${MINGW_PACKAGE_PREFIX}-bzip2"
             "${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-gcc-fortran"
             "${MINGW_PACKAGE_PREFIX}-cairo"
             "${MINGW_PACKAGE_PREFIX}-curl"
             "${MINGW_PACKAGE_PREFIX}-icu"
             "${MINGW_PACKAGE_PREFIX}-libtiff"
             "${MINGW_PACKAGE_PREFIX}-libjpeg"
             "${MINGW_PACKAGE_PREFIX}-libpng"
             "${MINGW_PACKAGE_PREFIX}-openblas"
             "${MINGW_PACKAGE_PREFIX}-pcre"
             "${MINGW_PACKAGE_PREFIX}-readline"
             "${MINGW_PACKAGE_PREFIX}-tcl"
             "${MINGW_PACKAGE_PREFIX}-tk"
             "${MINGW_PACKAGE_PREFIX}-xz"
             "${MINGW_PACKAGE_PREFIX}-zlib")
			 
# Manual extract because the official tarball conains recursive symlinks			 
source=(R-source.tar.gz::"https://cran.r-project.org/src/base-prerelease/R-devel.tar.gz")
noextract=(R-source.tar.gz)
sha256sums=('SKIP')

prepare() {
  rm -rf ${srcdir}/${_realname} && mkdir -p ${srcdir}/${_realname}
  MSYS="winsymlinks:lnk" tar -xf ${srcdir}/R-source.tar.gz -C ${srcdir}/${_realname} --strip-components=1

  # Hacks
  cd ${srcdir}/${_realname}
  cp src/gnuwin32/fixed/h/psignal.h src/include/
}

build() {
  rm -rf build-${CARCH} && mkdir -p build-${CARCH}
  cd "${srcdir}/build-${CARCH}"  
  
  export r_cv_bsd_networking=yes
  export CPPFLAGS="-DPCRE_STATIC"
  ${srcdir}/${_realname}/configure \
    --prefix=${MINGW_PREFIX} \
    --build=${MINGW_CHOST} \
    --host=${MINGW_CHOST} \
    --target=${MINGW_CHOST} \
    --without-x \
	--enable-R-shlib \
	--disable-java \
	--with-blas

  make
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  make DESTDIR="${pkgdir}" install
}
